# Test that presteps work

# Intial run
preguide gen -out _output
! stdout .+
! stderr .+
cmp _output/_posts/prestep.markdown prestep/en.markdown.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.golden

# Check that we get a cache hit
preguide -debug gen -out _output
! stdout .+
stderr '^cache hit for en: will not re-run script$'
cmp _output/_posts/prestep.markdown prestep/en.markdown.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.golden

# Verify that changing the prestep causes a new output
cp main.go.other main.go
preguide gen -out _output
! stdout .+
! stderr .+
cmp _output/_posts/prestep.markdown prestep/en.markdown.other.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.other.golden


-- go.mod --
module mod.com/init

go 1.12

require mvdan.cc/dockexec v0.0.0-20200525133310-74f6643d8839
-- main.go --
package main

import (
	"os"
	"encoding/json"
)

func main() {
	out := struct {
		Vars   []string
	}{
		Vars: []string{
			"GREETING="+os.Args[1],
		},
	}
	enc := json.NewEncoder(os.Stdout)
	_ = enc.Encode(out)
}
-- main.go.other --
package main

import (
	"fmt"
)

func main() {
	fmt.Println("{}")
}
-- prestep/en.markdown --
---
title: A test with all directives
---
# Step 1

<!--step: step1 -->
-- prestep/steps.cue --
package steps

import "github.com/play-with-go/preguide"

Presteps: [preguide.#Prestep & {
	Package: "mod.com/init"
	Args: ["Hello, world!"]
}]

Image: "this_will_never_be_used"

Steps: step1: en: preguide.#Command & {Source: """
echo "The answer is: $GREETING!"
"""}
-- prestep/en.markdown.golden --
---
image: playwithgo/go1.14.6@sha256:b3690d0dc29edfe2d740d3632175da32bc7301b8bec994060c11deaf99c71123
lang: en
title: A test with all directives
---
# Step 1

```.term1
$ echo "The answer is: $GREETING!"
The answer is: $GREETING!
```
-- prestep/en_testlog.txt.golden --
Image: playwithgo/go1.14.6@sha256:b3690d0dc29edfe2d740d3632175da32bc7301b8bec994060c11deaf99c71123
Presteps: [
  {
    "Package": "mod.com/init",
    "Version": "devel",
    "Args": [
      "Hello, world!"
    ]
  }
]
$ echo "The answer is: $GREETING!"
The answer is: $GREETING!
-- prestep/en.markdown.other.golden --
---
image: playwithgo/go1.14.6@sha256:b3690d0dc29edfe2d740d3632175da32bc7301b8bec994060c11deaf99c71123
lang: en
title: A test with all directives
---
# Step 1

```.term1
$ echo "The answer is: $GREETING!"
The answer is: !
```
-- prestep/en_testlog.txt.other.golden --
Image: playwithgo/go1.14.6@sha256:b3690d0dc29edfe2d740d3632175da32bc7301b8bec994060c11deaf99c71123
Presteps: [
  {
    "Package": "mod.com/init",
    "Version": "devel",
    "Args": [
      "Hello, world!"
    ]
  }
]
$ echo "The answer is: $GREETING!"
The answer is: !
