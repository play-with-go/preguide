# Test that presteps work

# Intial run
preguide gen -out _output
! stdout .+
! stderr .+
cmp _output/_posts/prestep.markdown prestep/en.markdown.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.golden

# Check that we get a cache hit
preguide -debug gen -out _output
! stdout .+
stderr '^cache hit for en: will not re-run script$'
cmp _output/_posts/prestep.markdown prestep/en.markdown.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.golden

# Verify that changing the prestep causes a new output
cp main.go.other main.go
preguide gen -out _output
! stdout .+
! stderr .+
cmp _output/_posts/prestep.markdown prestep/en.markdown.other.golden
cmp prestep/en_testlog.txt prestep/en_testlog.txt.other.golden


-- go.mod --
module mod.com/init

go 1.12

require mvdan.cc/dockexec v0.0.0-20200525133310-74f6643d8839
-- main.go --
package main

import (
	"fmt"
	"os"
	"encoding/json"
)

func main() {
	out := struct {
		Script string
		Vars   map[string]string
	}{
		Script: fmt.Sprintf("#!/usr/bin/env bash\nexport GREETING=%q\n", os.Args[1]),
		Vars: map[string]string{
			"$GREETING": os.Args[1],
		},
	}
	enc := json.NewEncoder(os.Stdout)
	_ = enc.Encode(out)
}
-- main.go.other --
package main

import (
	"fmt"
	"os"
	"encoding/json"
)

func main() {
	out := struct {
		Script string
		Vars   map[string]string
	}{
		Script: fmt.Sprintf("#!/usr/bin/env bash\nexport GREETING=%q\n", os.Args[1]),
	}
	enc := json.NewEncoder(os.Stdout)
	_ = enc.Encode(out)
}
-- prestep/en.markdown --
---
title: A test with all directives
---
# Step 1

<!--step: step1 -->
-- prestep/steps.cue --
package steps

import "github.com/play-with-go/preguide"

PreStep: {
	Package: "mod.com/init"
	Args: ["Hello, world!"]
}

Image: "this_will_never_be_used"

Steps: step1: en: preguide.#Command & {Source: """
echo $GREETING
"""}
-- prestep/en.markdown.golden --
---
image: playwithgo/go1.14.3@sha256:6289a34af0112146e551790d9f2a36622e083600752a02d36f1ad1f9e1389382
lang: en
title: A test with all directives
---
# Step 1

```.term1
$ echo $GREETING
$GREETING
```
-- prestep/en_testlog.txt.golden --
Image: playwithgo/go1.14.3@sha256:6289a34af0112146e551790d9f2a36622e083600752a02d36f1ad1f9e1389382
PreStep: {
  "Package": "mod.com/init",
  "Version": "devel",
  "Args": [
    "Hello, world!"
  ]
}
$ echo $GREETING
$GREETING
-- prestep/en.markdown.other.golden --
---
image: playwithgo/go1.14.3@sha256:6289a34af0112146e551790d9f2a36622e083600752a02d36f1ad1f9e1389382
lang: en
title: A test with all directives
---
# Step 1

```.term1
$ echo $GREETING
Hello, world!
```
-- prestep/en_testlog.txt.other.golden --
Image: playwithgo/go1.14.3@sha256:6289a34af0112146e551790d9f2a36622e083600752a02d36f1ad1f9e1389382
PreStep: {
  "Package": "mod.com/init",
  "Version": "devel",
  "Args": [
    "Hello, world!"
  ]
}
$ echo $GREETING
Hello, world!
